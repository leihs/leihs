-content_for :title, _("Hand Over to %s") % @user

#hand_over.innercontent
  .top
    %h1= yield :title
    %p.subtitle

  - if @contract.user.suspended_inventory_pools.include? current_inventory_pool
    .indent
      .notifications      
        .notification
          %strong= "#{_("Attention")}:"
          =_("This user is suspended")


  .indent
    = form_tag add_line_backend_inventory_pool_user_hand_over_path(current_inventory_pool, @contract.user), 
    :id => "process_helper", 
    :method => :post, 
    :remote => true,
    :"data-add_selected_line_ids" => "true",
    :"data-submit_button" => true do
      .dates
        .container
          %input.start.date{:type => "text", :name => "start_date", :id => "add_start_date", :"data-date" => (@visits.blank?) ? Date.today : @visits.first.lines.first.start_date  , :title => _("Start Date")}
          %label{:for => "add_start_date"}
            = _("Start Date")
          %label.datepicker.icon{:for => "add_start_date", :title => _("Open Datepicker")}
        = "-"
        .container
          %input.end.date{:type => "text", :name => "end_date", :id => "add_end_date", :"data-date" => (@visits.blank?) ? Date.today : @visits.first.lines.first.end_date, :title => _("End Date")}
          %label{:for => "add_end_date"}
            = _("End Date")
          %label.datepicker.icon{:for => "add_end_date", :title => _("Open Datepicker")}  
            
      .container
        %input.autocomplete.barcode_target{:type => "text", :name => "code", :autocomplete => "off", :id => "code", 
        :"data-url" => backend_inventory_pool_search_path(current_inventory_pool, :types => ["model", "option", "template"]),
        :"data-autocomplete_class" => "add_item", 
        :"data-autocomplete_element_tmpl" => "tmpl/autocomplete/add_item",
        :"data-autocomplete_select_callback" => "ProcessHelper.add_through_autocomplete"}
        %label{:for => "code"}
          = _("Inventory Code / Name")
        
      %button.button.white{:type => "submit"}
        = _("Add/Assign")
        .icon.placeholder
  
    #selection_actions
    
      .selection
        .text
          = _("Selection")
          %span.count= "(0)"
        
        .actions
          .multibutton{:"data-toggle_on_line_selection" => true}
            .alternatives
              .trigger.green
                .arrow
              = link_to "/backend/inventory_pools/#{current_inventory_pool.id}/users/#{@user.id}/hand_over/update_lines", 
              :class => "button white open_dialog",
              :"data-tmpl" => "tmpl/dialog/calendar", 
              :"data-dialog_class" => "calendar medium multiple",
              :"data-on_success" => 'HandOver.update_visits(response);',
              :"data-ref_for_dialog" => "Line.data_for_edit_lines(SelectedLines.lines_data)",
              :"data-dialog_ready" => "new BookingCalendar()",
              :id => "edit_selection" do
                .icon.timerange
                = _("Edit Selection")

              = link_to "/backend/inventory_pools/#{current_inventory_pool.id}/users/#{@user.id}/hand_over/swap_user.json",
              :class => "button white open_dialog",
              :title => _("Change Borrower"),
              :"data-tmpl" => "tmpl/dialog/swap_user/swap_user", 
              :"data-dialog_class" => "change_borrower swap_user medium",
              :"data-ref_for_dialog" => "HandOver.data_for_user_swap()",
              :"data-dialog_ready" => "SwapUser.setup();",
              :"data-on_success" => 'Dialog.add({content: $.tmpl("tmpl/dialog/loading", {title: "'+_("Change Borrower Successful")+'", message: "'+_("please wait...")+'"}), dialogClass: "loading"}); window.location = "/backend/inventory_pools/"+currentInventoryPool.id+"/users/"+response.new_user_id+"/hand_over"',
              :id => "change_borrower" do
                .icon.swap
                = _("Change Borrower")

              = link_to "/backend/inventory_pools/#{current_inventory_pool.id}/users/#{@contract.user.id}/hand_over/remove_lines",
              :class => "button white",
              :remote => "true",
              :method => "delete",
              :"data-tmpl" => "",
              :"data-dialog_class" => "",
              :"data-add_selected_line_ids" => "true",
              :"data-on_success" => "HandOver.remove_lines(SelectedLines.lines);",
              :"data-ref_for_dialog" => "",
              :id => "delete_selection" do
                .icon.delete
                = _("Delete Selection")
          
            = link_to "/backend/inventory_pools/#{current_inventory_pool.id}/users/#{@user.id}/hand_over/sign_contract", 
            :class => "button green open_dialog",
            :"data-tmpl" => "tmpl/dialog/hand_over/summary",
            :"data-dialog_class" => "medium hand_over",
            :"data-add_selected_line_ids" => "true",
            :"data-on_success" => "HandOver.open_documents(response)",
            :id => "hand_over_button" do
              = _("Hand Over Selection")
            
    .clear
  %hr
  
  #visits

:ruby
  visits_json = json_for @visits, {:preset => :hand_over_visit} 

:coffeescript    

  visits_json = #{visits_json}

  jQuery ->
    $('#visits').html($.tmpl("tmpl/visit", visits_json))
    window.current_customer = #{@contract.user.id}
    HandOver.setup()
    ProcessHelper.setup()
    SelectedLines.setup()
    
